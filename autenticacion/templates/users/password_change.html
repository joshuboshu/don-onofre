{% extends "proyectowebapp/base.html" %}
{% load static %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card shadow-lg">
                <div class="card-header bg-warning text-white">
                    <h3 class="card-title mb-0 text-center">Cambiar Contraseña</h3>
                </div>
                <div class="card-body">
                    <form id="passwordForm" action="{% url 'password_change' %}" method="post">
                        {% csrf_token %}
                        
                        <!-- Contraseña actual -->
                        <div class="mb-3">
                            <label for="old_password" id="old_password_label" class="form-label">Contraseña Actual</label>
                            <input type="password" id="old_password" name="old_password" class="form-control" required>
                            <small id="oldPasswordWarning" class="text-danger d-none">La contraseña actual es incorrecta.</small>
                        </div>
                        
                        <!-- Nueva contraseña -->
                        <div class="mb-3">
                            <label for="new_password" class="form-label">Nueva Contraseña</label>
                            <input type="password" id="new_password" name="new_password" class="form-control" required>
                            <small id="passwordLengthWarning" class="text-danger d-none">La contraseña debe tener al menos 8 caracteres.</small>
                            <small id="passwordSameAsOldWarning" class="text-danger d-none">La nueva contraseña no puede ser igual a la actual.</small>
                        </div>
                        
                        <!-- Confirmar nueva contraseña -->
                        <div class="mb-3">
                            <label for="confirm_password" class="form-label">Confirmar Nueva Contraseña</label>
                            <input type="password" id="confirm_password" name="confirm_password" class="form-control" required>
                            <small id="passwordMismatchWarning" class="text-danger d-none">Las contraseñas no coinciden.</small>
                        </div>
                        
                        <!-- Botón de envío -->
                        <div class="d-grid gap-2 mt-4">
                            <button type="submit" class="btn btn-danger btn-lg">
                                <i class="fas fa-key me-2"></i>Cambiar Contraseña
                            </button>
                        </div>
                    </form>
                    
                    <!-- Enlace de regreso al perfil -->
                    <div class="text-center mt-3">
                        <a href="{% url 'profile' %}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left me-2"></i>Volver Atrás
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de éxito -->
<div class="modal fade" id="successModal" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="successModalLabel">Éxito</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                <p>¡Tu contraseña ha sido cambiada exitosamente!</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="redirectProfile">Volver al Perfil</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de error -->
<div class="modal fade" id="errorModal" tabindex="-1" aria-labelledby="errorModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="errorModalLabel">Error</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <i class="fas fa-exclamation-circle fa-3x text-danger mb-3"></i>
                <p id="errorMessage">Hubo un error al cambiar la contraseña. Inténtalo de nuevo.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/js/all.min.js"></script>
<script>
    $(document).ready(function() {
        let oldPasswordValue = "";

        // Validación de la contraseña actual
        $('#old_password').on('blur', function() {
            oldPasswordValue = $(this).val();
            $.ajax({
                url: "{% url 'password_change' %}",
                type: 'POST',
                headers: { 'X-CSRFToken': '{{ csrf_token }}' },
                data: { old_password: oldPasswordValue },
                success: function(data) {
                    if (data.message === 'La contraseña actual es incorrecta.') {
                        $('#oldPasswordWarning').removeClass('d-none');
                        $('#old_password').addClass('border-danger');
                    } else {
                        $('#oldPasswordWarning').addClass('d-none');
                        $('#old_password').removeClass('border-danger').addClass('border-success');
                    }
                }
            });
        });

        // Validación de longitud de la nueva contraseña y que no sea igual a la actual
        $('#new_password').on('input', function() {
            const newPassword = $(this).val();
            if (newPassword.length < 8) {
                $('#passwordLengthWarning').removeClass('d-none');
                $(this).addClass('border-danger');
            } else {
                $('#passwordLengthWarning').addClass('d-none');
                $(this).removeClass('border-danger').addClass('border-success');
            }

            if (newPassword === oldPasswordValue) {
                $('#passwordSameAsOldWarning').removeClass('d-none');
                $(this).addClass('border-danger');
            } else {
                $('#passwordSameAsOldWarning').addClass('d-none');
            }
        });

        // Verificación de coincidencia de contraseñas
        $('#new_password, #confirm_password').on('input', function() {
            if ($('#new_password').val() !== $('#confirm_password').val()) {
                $('#passwordMismatchWarning').removeClass('d-none');
                $('#confirm_password').addClass('border-danger');
            } else {
                $('#passwordMismatchWarning').addClass('d-none');
                $('#confirm_password').removeClass('border-danger').addClass('border-success');
            }
        });

        // Envío del formulario y manejo del éxito o error
        $('#passwordForm').on('submit', function(e) {
            e.preventDefault();
            if ($('#new_password').val() !== $('#confirm_password').val()) {
                $('#passwordMismatchWarning').removeClass('d-none');
                return;
            }
            $.ajax({
                url: "{% url 'password_change' %}",
                type: 'POST',
                headers: { 'X-CSRFToken': '{{ csrf_token }}' },
                data: $(this).serialize(),
                success: function(data) {
                    if (data.success) {
                        $('#successModal').modal('show');
                    } else {
                        $('#errorMessage').text(data.message);
                        $('#errorModal').modal('show');
                    }
                }
            });
        });

        // Redirección al perfil tras cerrar el modal
        $('#redirectProfile').on('click', function() {
            window.location.href = "{% url 'profile' %}";
        });
    });
</script>
{% endblock %}
